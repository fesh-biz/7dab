<?php

namespace Tests\Feature\Redis\Repositories;

use App\Data\Media\CreateMediaRedisData;
use App\Data\Media\MediaRedisData;
use App\Redis\Models\MediaRedis;
use App\Redis\Repositories\MediaRedisRepository as MediaRepo;
use Tests\TestCase;

class MediaRedisRepositoryTest extends TestCase
{
    protected MediaRepo $repo;

    protected function setUp(): void
    {
        $this->repo = app()->make(MediaRepo::class);
        $this->repo->deleteAll();
        parent::setUp(); // TODO: Change the autogenerated stub
    }

    /**
     * @test
     * @group MediaRedisRepository
     */
    public function method_create()
    {
        $id = 2;
        $data = new CreateMediaRedisData($id, 'image/jpeg', 5);
        $this->repo->create($data);
        $media = $this->repo->find($id);

        foreach ($data->toArray() as $field => $value) {
            $this->assertEquals($value, $media->{$field});
        }
    }

    /**
     * @test
     * @group MediaRedisRepository
     */
    public function incrementFailedAttempts()
    {
        $id = 1;
        $data = new CreateMediaRedisData($id, 'image/jpeg', 3);
        $this->repo->create($data);

        /** @var MediaRedis $media */
        $media = $this->repo->find($id);
        $this->assertTrue($media->failed_attempts === 0);

        $this->repo->incrementFailedAttempts($id);
        $media = $this->repo->find($id);
        $this->assertTrue($media->failed_attempts === 1);
    }

    /**
     * @test
     * @group MediaRedisRepository
     */
    public function getUploadedMediaChunks()
    {
        ['mediaId' => $mediaId, 'chunks' => $chunks] = $this->createMediaWithChunks();

        $createdChunks = $this->repo->getUploadedMediaChunks($mediaId);

        foreach ($chunks as $index => $chunk) {
            $createdChunk = $createdChunks[$index];

            $this->assertTrue($chunk['filename'] === $createdChunk->filename);
            $this->assertTrue($chunk['size'] === $createdChunk->size);
        }
    }

    /**
     * @test
     * @group MediaRedisRepository
     */
    public function getUploadedMediaChunksSize()
    {
        ['mediaId' => $mediaId, 'chunksSize' => $chunksSize] = $this->createMediaWithChunks();

        $uploadedChunksSize = $this->repo->getUploadedMediaChunksSize($mediaId);

        $this->assertEquals($chunksSize, $uploadedChunksSize);
    }

    /**
     * @test
     * @group MediaRedisRepository
     */
    public function addFileChunk()
    {
        ['mediaId' => $mediaId, 'chunks' => $chunks] = $this->createMediaWithChunks();

        $filename = 'new chunk';
        $size = 4234;
        $this->repo->addFileChunk($mediaId, $filename, $size);

        /** @var MediaRedis $media */
        $media = $this->repo->find($mediaId);
        $this->assertTrue(count($media->chunks) === count($chunks) + 1, 'Chunks amount mismatch');

        $addedChunk = $media->chunks;
        $addedChunk = end($addedChunk);
        $this->assertEquals($filename, $addedChunk->filename);
        $this->assertEquals($size, $addedChunk->size);
    }

    private function createMediaWithChunks(): array
    {
        $mediaId = 2;
        $totalChunks = 10;
        $data = new CreateMediaRedisData($mediaId, 'image/jpeg', $totalChunks);
        $this->repo->create($data);

        $chunks = [];
        $chunksSize = 0;
        foreach (range(1, $totalChunks) as $id) {
            $size = $id * 10;
            $chunksSize += $size;

            $chunks[] = [
                'filename' => 'chunk' . $id,
                'size' => $size
            ];
        }

        $data = new MediaRedisData($mediaId, 'image/jpeg', $chunks);
        $this->repo->update($mediaId, $data);

        return [
            'mediaId' => $mediaId,
            'chunks' => $chunks,
            'chunksSize' => $chunksSize
        ];
    }
}
